<script>


  // TODO: сделать проверку на дубликаты email

  // -------------------------------------------------------
  // ------------------------ РЕГИСТРАЦИЯ ------------------
  // -------------------------------------------------------

  document.getElementById('submitRegBtn').addEventListener('click', startRegister);

  // валидация полей email и password для регистрации
  function startRegister() {
    const EMAIL_INP = document.getElementById('registrationEmail');
    const PASSWORD_INP = document.getElementById('registrationPassword');
    const REPEATED_PASSWORD_INP = document.getElementById('registrationPasswordRepeated');
    const EMAIL_MESSAGE = document.getElementById('invalidRegEmail');
    const PASSWORD_MESSAGE = document.getElementById('invalidRegPassword');
    const REPEATED_PASSWORD_MESSAGE = document.getElementById('invalidRegPasswordRepeated');
    let isCorrectUserData = true;
    let email = EMAIL_INP.value.trim();
    let password = PASSWORD_INP.value.trim();
    let passwordRepeated = REPEATED_PASSWORD_INP.value.trim();

    if (isEmpty(email)) {
      showMessage(false, EMAIL_INP, EMAIL_MESSAGE, 'Поле не может быть пустым');
      isCorrectUserData = false;
    } else if (!isValidEmailFormat(email)) {
      showMessage(false, EMAIL_INP, EMAIL_MESSAGE, 'Пожалуйста, введите правильный email адрес');
      isCorrectUserData = false;
    } else {
      showMessage(true, EMAIL_INP, EMAIL_MESSAGE);
    }

    if (password !== passwordRepeated) {
      showMessage(false, REPEATED_PASSWORD_INP, REPEATED_PASSWORD_MESSAGE, 'Пароли не совпадают');
      isCorrectUserData = false;
    } else if (isEmpty(password)) {
      showMessage(false, PASSWORD_INP, PASSWORD_MESSAGE, 'Поле не может быть пустым');
      isCorrectUserData = false;
    } else if (isEmpty(passwordRepeated)) {
      showMessage(false, REPEATED_PASSWORD_INP, REPEATED_PASSWORD_MESSAGE, 'Поле не может быть пустым');
      isCorrectUserData = false;
    } else {
      showMessage(true, REPEATED_PASSWORD_INP, REPEATED_PASSWORD_MESSAGE);
    }
    

    if (isCorrectUserData) {
      google.script.run
        .withSuccessHandler(showConfirmationField)
        .registerProcessor({mode: 1, email: email, password: password});
    }

  }





  // TODO: сделать проверку на дубликаты email
  // function returnExistEmail(email, response) {
  //   if (response == undefined) {

  //   }
  //   if (response != undefined) {
  //     return response
  //   }
  // }




  // функция для отображения поля ввода кода подтверждения
  function showConfirmationField(response) {
    if (!response.success) {
      // let modalBody = document.getElementById('modalBody');
      // modalBody.innerHTML = '';
      console.log(response.errorMessage)
      return
    }
    const REGISTRATION_FORM = document.getElementById('registrationForm');
    const CONFIRMATION_FORM = document.getElementById('confirmCodeForm');
    REGISTRATION_FORM.classList.toggle('hidden');
    CONFIRMATION_FORM.classList.toggle('hidden');
  }

  // confirmation part
  document.getElementById('confirmCodeBtn').addEventListener('click', startConfirmation);

  // функция для отображения поля ввода кода подтверждения
  function startConfirmation() {
    let confirmCodeForm = document.getElementById('confirmCodeForm');
    let spinner = document.getElementById('confirmSpinner');
    confirmCodeForm.classList.toggle('hidden');
    spinner.classList.toggle('hidden');
    let confirmCode = document.getElementById('confirmCodeInput').value.trim();
    google.script.run.withSuccessHandler(finishConfirmation).registerProcessor({mode: 2, userConfirmationCode: confirmCode});
  }



  // если код подтверддения правильный - создаем новый документ
  function finishConfirmation(response) {
    if (!response.success) {
      document.getElementById('confirmCodeForm').classList.toggle('hidden');
      document.getElementById('confirmCodeInput').classList.toggle('is-invalid');
      document.getElementById('confirmSpinner').classList.toggle('hidden');
      return
    }
    document.getElementById('successTitle').classList.toggle('hidden');
    google.script.run.withSuccessHandler(prosessRedirect).registerProcessor({mode: 3});
  }

</script>