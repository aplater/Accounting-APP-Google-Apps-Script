<script>
  (function () {
    console.log(`Проверка авторизации`)
    let data = {
      email: null,
      password: null,
      sheetId: null,
      mode: 1
    }
    let email = localStorage.getItem('email');
    let sshKey = localStorage.getItem('sshKey');
    let sheetId = localStorage.getItem('sheetId');
    console.log(`email`)
    console.log(email)
    console.log(`sshKey`)
    console.log(sshKey)
    console.log(`sheetId`)
    console.log(sheetId)


    if (email === null || sshKey === null || sheetId === null) {
      console.log("Не авторизирован!");
      return false;
    }
    data.email = email;
    data.password = sshKey;
    data.sheetId = sheetId;

    // проверить все три ключа, если все ок - перенаправить на домашнюю страницу
    google.script.run.withSuccessHandler(prosessRedirect).checkAuthData(data);
  })();



 

  // перенаправляем в личный кабинет, передавая id таблицы пользователя с данными
  function prosessRedirect(response) {
    let sheetId;
    console.log(response.successMessage)
    console.log(response.errorMessage)

    if (response.success == true && response.newUser == true) {
      console.log(response.successMessage)
      console.log(`попал в первый иф`)
      localStorage.setItem('email', response.email);
      localStorage.setItem('sshKey', response.passwordSSH);
      localStorage.setItem('sheetId', response.userSheetId);
      sheetId = response.userSheetId;
    } else if (response.success == true && response.newUser == false && response.userSheetId != undefined) {
      console.log(`попал в второй иф`)
      sheetId = response.userSheetId;
    }

    if (sheetId == undefined) {
      console.log('sheetId == undefined')
      clearLocalStorage();
      return false
    }

    if (response.success == false) {
      console.log('Ответ сервера - отрицательній')
      clearLocalStorage();
      return false
    }

    console.log(`вышел сюда`)

    // console.log(sheetID)
    let currenUrl = document.getElementById('currentUrl').value;
    console.log(currenUrl)
    let link = document.createElement("a");
    link.setAttribute("href", `${String(currentUrl.value)}?v=home&sheetId=${sheetId}`);
    link.setAttribute("id", 'uiLink');
    link.innerText = '';
    document.body.append(link);
    console.log('Сработало')
    setTimeout(() => document.getElementById('uiLink').click(), 3000);
  }
































  document.getElementById("loginFormSbmBtn").addEventListener('click', checkUserLogin);




  function checkUserLogin() {
    // добавить кнопку "запомнить меня"
    let data = {
      email: null,
      password: null,
      mode: 2
    }

    console.log('Отправляю данные на сервер...');
    let email = document.getElementById('loginFormEmail');
    let password = document.getElementById('loginFormPassword');

    if (isEmpty(email.value)) {
      console.log('Email пустой')
      // showMessage(false, email, textField, message);

    }
    if (isEmpty(password.value)) {
      console.log('Поле с паролем пустое')
      // showMessage(false, email, textField, message);
    }


    if (isValidEmailFormat(email.value)) {
      data.email = email.value;
    } else {
      console.log('неправильный email формат')
      // showMessage(false, email, textField, message);
    }
    console.log(`data для отправки на сервер`)

    console.log(data)
    data.password = password.value;
    google.script.run.withSuccessHandler(prosessRedirect).checkAuthData(data);
  }


</script>